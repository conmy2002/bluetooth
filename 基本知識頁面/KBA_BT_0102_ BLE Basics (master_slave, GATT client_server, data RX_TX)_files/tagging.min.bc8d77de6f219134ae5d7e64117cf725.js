(function(c){c.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,requireAutocomplete:!0,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,
tagSource:null},_create:function(){var a=this;this.element.is("input")?(this.tagList=c("\x3cul\x3e\x3c/ul\x3e").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.css("display","none")):this.tagList=this.element.find("ul, ol").andSelf().last();this.tagInput=c('\x3cinput type\x3d"text" /\x3e').addClass("ui-widget-content");this.options.readOnly&&this.tagInput.attr("disabled","disabled");this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex);
this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText);this.options.autocomplete.source||(this.options.autocomplete.source=function(a,b){var d=a.term.toLowerCase();a=c.grep(this.options.availableTags,function(a){return 0===a.toLowerCase().indexOf(d)});this.options.allowDuplicates||(a=this._subtractArray(a,this.assignedTags()));b(a)});this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(c,b){a._showAutocomplete()}),"undefined"===typeof this.options.autocomplete.minLength&&
(this.options.autocomplete.minLength=0));c.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=c.proxy(this.options.autocomplete.source,this));c.isFunction(this.options.tagSource)&&(this.options.tagSource=c.proxy(this.options.tagSource,this));this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(c('\x3cli class\x3d"tagit-new"\x3e\x3c/li\x3e').append(this.tagInput)).click(function(b){var d=c(b.target);d.hasClass("tagit-label")?(d=d.closest(".tagit-choice"),
d.hasClass("removed")||a._trigger("onTagClicked",b,{tag:d,tagLabel:a.tagLabel(d)})):a.tagInput.focus()});var d=!1;if(this.options.singleField)if(this.options.singleFieldNode){var b=c(this.options.singleFieldNode),e=b.val().split(this.options.singleFieldDelimiter);b.val("");c.each(e,function(c,b){a.createTag(b,null,null,!0);d=!0})}else this.options.singleFieldNode=c('\x3cinput type\x3d"hidden" style\x3d"display:none;" value\x3d"" name\x3d"'+this.options.fieldName+'" /\x3e'),this.tagList.after(this.options.singleFieldNode);
d||this.tagList.children("li").each(function(){c(this).hasClass("tagit-new")||(a.createTag(c(this).text(),null,c(this).attr("class"),!0),c(this).remove())});this.tagInput.keydown(function(b){if(b.which==c.ui.keyCode.BACKSPACE&&""===a.tagInput.val()){var d=a._lastTag();!a.options.removeConfirmation||d.hasClass("remove")?a.removeTag(d):a.options.removeConfirmation&&d.addClass("remove ui-state-highlight")}else a.options.removeConfirmation&&a._lastTag().removeClass("remove ui-state-highlight");!0!==a.options.requireAutocomplete&&
(b.which===c.ui.keyCode.COMMA||b.which===c.ui.keyCode.ENTER||b.which==c.ui.keyCode.TAB&&""!==a.tagInput.val()||b.which==c.ui.keyCode.SPACE&&!0!==a.options.allowSpaces&&('"'!=c.trim(a.tagInput.val()).replace(/^s*/,"").charAt(0)||'"'==c.trim(a.tagInput.val()).charAt(0)&&'"'==c.trim(a.tagInput.val()).charAt(c.trim(a.tagInput.val()).length-1)&&0!==c.trim(a.tagInput.val()).length-1))&&(b.which===c.ui.keyCode.ENTER&&""===a.tagInput.val()||b.preventDefault(),a.tagInput.data("autocomplete-open")||a.createTag(a._cleanedInput()))}).blur(function(c){!0!==
a.options.requireAutocomplete&&(a.tagInput.data("autocomplete-open")||a.createTag(a._cleanedInput()))});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source)b={select:function(c,b){a.createTag(b.item.value,b.item.id);return!1}},c.extend(b,this.options.autocomplete),b.source=this.options.tagSource||b.source,this.tagInput.autocomplete(b).bind("autocompleteopen",function(c,b){a.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose",function(c,b){a.tagInput.data("autocomplete-open",
!1)})},_cleanedInput:function(){return c.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var a=this,d=[];this.options.singleField?(d=c(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===d[0]&&(d=[])):this._tags().each(function(){d.push(a.tagLabel(this))});return d},_updateSingleTagsField:function(a){c(this.options.singleFieldNode).val(a.join(this.options.singleFieldDelimiter)).trigger("change")},
_subtractArray:function(a,d){for(var b=[],e=0;e<a.length;e++)-1==c.inArray(a[e],d)&&b.push(a[e]);return b},tagLabel:function(a){return this.options.singleField?c(a).find(".tagit-label:first").text():c(a).find("input:first").val()},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(a){var d=this,b=null;this._tags().each(function(e){if(d._formatStr(a)==d._formatStr(d.tagLabel(this)))return b=c(this),!1});return b},_isNew:function(a){return!this._findTagByLabel(a)},
_formatStr:function(a){return this.options.caseSensitive?a:c.trim(a.toLowerCase())},_effectExists:function(a){return!(!c.effects||!(c.effects[a]||c.effects.effect&&c.effects.effect[a]))},createTag:function(a,d,b,e){var h=this,g=d;g||(d=c('input[name\x3d"'+this.options.fieldName+'"]'),c.each(d,function(b,d){b=c(d).attr("value").toLowerCase();0<b.indexOf(a.toLowerCase())&&(g=b)}));a=c.trim(a);this.options.preprocessTag&&(a=this.options.preprocessTag(a));if(""===a)return!1;if(!(this.options.allowDuplicates||
this._isNew(a)&&this._isNew(g)))return b=this._findTagByLabel(g)?this._findTagByLabel(g):this._findTagByLabel(a),!1!==this._trigger("onTagExists",null,{existingTag:b,duringInitialization:e})&&this._effectExists("highlight")&&b.effect("highlight"),!1;if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger("onTagLimitExceeded",null,{duringInitialization:e}),!1;d=c(this.options.onTagClicked?'\x3ca class\x3d"tagit-label"\x3e\x3c/a\x3e':'\x3cspan class\x3d"tagit-label"\x3e\x3c/span\x3e').text(a);
var f=c("\x3cli\x3e\x3c/li\x3e").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(b).append(d);this.options.readOnly?f.addClass("tagit-choice-read-only"):(f.addClass("tagit-choice-editable"),b=c("\x3cspan\x3e\x3c/span\x3e").addClass("ui-icon ui-icon-close"),b=c('\x3ca\x3e\x3cspan class\x3d"text-icon"\x3e\u00d7\x3c/span\x3e\x3c/a\x3e').addClass("tagit-close").append(b).click(function(a){h.removeTag(f)}),f.append(b));this.options.singleField||(b=g?g:d.html(),f.append('\x3cinput type\x3d"hidden" style\x3d"display:none;" value\x3d"'+
b+'" name\x3d"'+this.options.fieldName+'" /\x3e'));!1!==this._trigger("beforeTagAdded",null,{tag:f,tagLabel:this.tagLabel(f),duringInitialization:e})&&(this.options.singleField&&(b=this.assignedTags(),b.push(a),this._updateSingleTagsField(b)),this._trigger("onTagAdded",null,f),this.tagInput.val(""),this.tagInput.parent().before(f),this._trigger("afterTagAdded",null,{tag:f,tagLabel:this.tagLabel(f),duringInitialization:e}),this.options.showAutocompleteOnFocus&&!e&&setTimeout(function(){h._showAutocomplete()},
0))},removeTag:function(a,d){d="undefined"===typeof d?this.options.animate:d;a=c(a);this._trigger("onTagRemoved",null,a);if(!1!==this._trigger("beforeTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)})){if(this.options.singleField){var b=this.assignedTags(),e=this.tagLabel(a);b=c.grep(b,function(a){return a!=e});this._updateSingleTagsField(b)}if(d){a.addClass("removed");d=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"];var h=this;d.push(function(){a.remove();h._trigger("afterTagRemoved",
null,{tag:a,tagLabel:h.tagLabel(a)})});a.fadeOut("fast").hide.apply(a,d).dequeue()}else a.remove(),this._trigger("afterTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)})}},removeTagByLabel:function(a,c){var b=this._findTagByLabel(a);if(!b)throw"No such tag exists with the name '"+a+"'";this.removeTag(b,c)},removeAll:function(){var a=this;this._tags().each(function(c,b){a.removeTag(b,!1)})}})})($CQ);