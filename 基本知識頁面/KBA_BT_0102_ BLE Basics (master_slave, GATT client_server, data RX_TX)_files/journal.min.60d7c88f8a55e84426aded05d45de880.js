(function(c,d){c.soco=c.soco||{};c.soco.commons=c.soco.commons||{};c.soco.TEMPLATE_PARAMNAME=":templatename";c.soco.filterHTMLFragment=c.soco.filterHTMLFragment||function(c,a){try{a.call(null,d(c))}catch(l){throw l;}};c.soco.commons.handleOnBlur=function(c,a){""!==d(c).val()&&"\x3cbr/\x3e"!==d(c).val()||d(c).val(a)};c.soco.commons.handleOnFocus=function(c,a){d(c).val()===a&&d(c).val("")};c.soco.commons.getMessage=function(c){var a=d(c).first().val();"undefined"!==typeof CKEDITOR&&(c=CKEDITOR.instances[d(c).attr("id")])&&
(a=c.getData());return a};c.soco.commons.validateFieldNotEmptyOrDefaultMessage=function(f,a){c.soco.commons.syncRTE(f);var l=d(f).val();a||(a="");var k="tempRTEValidate_"+Math.floor(1001*Math.random());d(f).after("\x3cdiv id\x3d'"+k+"' height\x3d'0px' style\x3d'visibility:hidden;' width\x3d'0px'\x3e\x3c/div\x3e");l=c.soco.commons.stripNonText(l);a=c.soco.commons.stripNonText(a);d("#"+k).append(l);d("#"+k+" div:empty").filter(function(){return d(this)}).remove();d("#"+k+" p:empty").filter(function(){return d(this)}).remove();
l=d("#"+k).html();d("#"+k).remove();return 0===d.trim(l).length||d.trim(l)===a?(alert(c.I18n.getMessage("Comment field cannot be empty or default message.")),!1):!0};c.soco.commons.stripNonText=function(c){c=c.replace(/\s|&nbsp;/g,"");c=c.replace(/\r?\n|\r/g,"");return c=c.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g,"")};c.soco.commons.syncRTE=function(c){if("undefined"!==typeof CKEDITOR){var a=CKEDITOR.instances[d(c).attr("name")];a||(a=CKEDITOR.instances[d(c).attr("id")]);a&&a.checkDirty()&&(a.updateElement(),
a.resetDirty())}};c.soco.commons.clientSideComposer=function(f,a,l,k,n,p,q){var t=p||f.attr("action"),v=q||f.attr("method")||"POST";f.find(":submit").click(function(u){if(!(0<$.map(f.find(":input[type\x3d'file']"),function(b){b=$(b);return""===b.val()||void 0===b.val()?null:!0}).length)){u.preventDefault();var g=d(u.target).closest("form")[0];if(!d.isFunction(g.onsubmit)||g.onsubmit.call(g,u)){u=f.find("textarea");c.soco.commons.syncRTE(u);u=d(g).serialize();a&&(u+="\x26"+encodeURIComponent(c.soco.TEMPLATE_PARAMNAME)+
"\x3d"+encodeURIComponent(a));for(var e in n)u+="\x26"+encodeURIComponent(e)+"\x3d"+encodeURIComponent(n[e]);d(g).find(":input:visible").each(function(){d(this).attr("disabled","disabled")});d.ajax(t,{data:u,success:function(b,a,c){201===c.status||200===c.status?(d(g).find(":input:visible").each(function(){switch(this.type){case "password":case "select-multiple":case "select-one":case "text":case "textarea":d(this).val("");break;case "checkbox":case "radio":this.checked=!1}d(this).removeAttr("disabled")}),
d(g).find(":input:hidden").each(function(){d(this).trigger("lcl.cq.soco.events.clear")}),l.call(null,b,a,c)):(d(g).find(":input:visible").each(function(){d(this).removeAttr("disabled")}),k.call(null,c,a))},fail:function(b,a){d(g).find(":input:visible").each(function(){d(this).removeAttr("disabled")});k.call(null,b,a)},type:v})}}})};c.soco.commons.fillInputFromClientContext=function(c,a){window.CQ_Analytics&&CQ_Analytics.CCM&&d(function(){var d=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
d&&(d=d.getProperty(a,!0)||"",c.val(d));CQ_Analytics.CCM.addListener("storesloaded",function(){var d=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);if(d&&d.addListener){var f=d.getProperty(a,!0)||"";c.val(f);d.addListener("update",function(){var f=d.getProperty(a,!0)||"";c.val(f)})}})})};c.soco.commons.activateRTE=function(d,a){d=d.find("textarea");c.soco.commons.convertTextAreaToRTE(d,a,!0)};c.soco.commons.convertTextAreaToRTE=function(f,a,l){var k=f.width(),n=f.height(),
p=f[0],q,t=a||["onfocus","onblur"];if(null!==p&&"undefined"!==typeof p)for(q=0;q<t.length;q++)a=t[q],null!==p[a]&&a.substring(2);a=null;d(f).height(f.height()+60);a={width:k,height:n,toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline"]}]};l?(a.width=k+4,a.height=n+60):(a.width=0===f.width()?"100%":k,a.height=0===f.height()?"100%":n,a.toolbarLocation="bottom",a.resize_enabled=!1,a.removePlugins="elementspath");var v=CKEDITOR.replace(d(f).attr("name"),a);v.on("key",function(a){c.soco.commons.syncRTE(f)});
f.on("lcl.cq.soco.events.clear",function(a){d(p).val("");v.setData("",function(){d(v).blur();v.resetDirty()})});return v};c.soco.commons.openModeration=function(){void 0!==c.WCM&&void 0!==c.WCM.getPagePath&&c.WCM.getPagePath();c.shared.Util.open(c.shared.HTTP.externalize("/communities/moderation.html"))};c.soco.commons.showUGCFormAsDialog=function(c,a){var f=d(a);a=f.attr("id");var k="modalIframeParent"+Math.random().toString(36).substring(2,4);a||(f.attr("id",k),a=k);f.dialog({modal:!0,height:500,
width:750,buttons:{Submit:function(){d("iframe.modalIframeClass",f).contents().find("form").submit();d(this).dialog("close")},Cancel:function(){d(this).dialog("close")}}});f.html("\x3ciframe class\x3d'modalIframeClass' width\x3d'100%' height\x3d'100%' marginWidth\x3d'0' marginHeight\x3d'0' frameBorder\x3d'0' /\x3e").dialog("open");d("#"+a+" .modalIframeClass").attr("src",c);return!1}})(CQ,$CQ);
var CQ_collab_comments_loadedForms={},CQ_collab_comments_defaultMessage="",CQ_collab_comments_requireLogin=!1,CQ_collab_comments_enterComment="Please enter a comment";
function CQ_collab_comments_toggleForm(c,d,f){var a=document.getElementById(d);c=document.getElementById(c);try{f=CQ.shared.HTTP.noCaching(f),CQ.shared.HTTP.get(f,function(c,d,f){c=f.responseText;$CQ(a).html(c);if(c=$CQ(a).children("form").attr("id"))c=c.split("-"),--c.length,c=c.join("-"),CQ_Analytics&&CQ_Analytics.CCM&&(d=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME))&&CQ_collab_comments_formStateChanged(c,d)})}catch(l){alert("Error loading form: "+f)}f="block"!=a.style.display;
a.style.display=f?"block":"none";c.innerHTML=f?"Cancel":"Reply"}function CQ_collab_comments_handleOnFocus(c,d){c.value==CQ_collab_comments_getDefaultMessage(d)&&(c.value="");c.style.color="#333"}function CQ_collab_comments_handleOnBlur(c,d){""===c.value?(c.value=CQ_collab_comments_getDefaultMessage(d),c.style.color="#888"):c.style.color="#333"}
function CQ_collab_comments_validateFields(c){var d=document.getElementById(c+"-text");return""===d.value||d.value===CQ_collab_comments_getDefaultMessage(c)?(CQ_collab_comments_showError(CQ_collab_comments_enterComment,c),!1):!0}
function CQ_collab_comments_validateSubmit(c){if(!CQ_collab_comments_validateFields(c))return!1;try{var d=document.getElementById(c+"-id");if(!d){var f=document.getElementById(c+"-form");d=document.createElement("input");d.id=c+"-id";d.type="hidden";d.name="id";d.value="nobot";f.appendChild(d)}}catch(a){return!1}return!0}function CQ_collab_comments_showError(c,d){(d=document.getElementById(d+"-error"))?d.innerHTML=c:alert(c)}
function CQ_collab_comments_getDefaultMessage(c){return c&&document.getElementById(c+"-rating")?CQ_collab_ratings_defaultMessage:CQ_collab_comments_defaultMessage}function CQ_collab_comments_openCollabAdmin(){CQ.shared.Util.open(CQ.shared.HTTP.externalize("/socoadmin.html#/content/usergenerated"+CQ.WCM.getPagePath()))}
function CQ_collab_comments_activate(c,d){c||(c="Activate");CQ.HTTP.post("/bin/replicate.json",function(f,a,l){"Delete"===c?CQ.Notification.notify(null,a?CQ.I18n.getMessage("Comment deleted"):CQ.I18n.getMessage("Unable to delete comment")):CQ.Notification.notify(null,a?CQ.I18n.getMessage("Comment activated"):CQ.I18n.getMessage("Unable to activate comment"));d&&d.call(this,f,a,l)},{_charset_:"utf-8",path:this.path,cmd:c})}
function CQ_collab_comments_refresh(){this.refreshCommentSystem?this.refreshCommentSystem():CQ.wcm.EditBase.refreshPage()}function CQ_collab_comments_afterEdit(c){CQ_collab_comments_activate.call(c,"Activate",CQ_collab_comments_refresh)}function CQ_collab_comments_afterDelete(c){CQ_collab_comments_activate.call(c,"Delete",CQ_collab_comments_refresh)}
function CQ_collab_comments_initFormState(c){CQ_Analytics&&CQ_Analytics.CCM&&$CQ(function(){CQ_Analytics.ClientContextUtils.onStoreRegistered(CQ_Analytics.ProfileDataMgr.STORENAME,function(d){CQ_collab_comments_formStateChanged(c,d);d.addListener("update",function(){CQ_collab_comments_formStateChanged(c,d)})})})}
function CQ_collab_comments_formStateChanged(c,d){var f=d.getData();if(f){d=c+"-form";var a=c+"-userIdentifier",l=c+"-email";c+="-url";var k=f.authorizableId;(f=f.formattedName)||(f=k);k&&"anonymous"==k?CQ_collab_comments_requireLogin?($CQ("#"+d).hide(),$CQ("[id$\x3d-reply-button]").hide(),$CQ("[id$\x3d-reply-arrow]").hide()):($CQ("#"+d).show(),$CQ("[id$\x3d-reply-button]").show(),$CQ("[id$\x3d-reply-arrow]").show(),$CQ("#"+a).attr("value",""),$CQ("#"+a+"-comment-block").show(),$CQ("#"+l).attr("value",
""),$CQ("#"+l+"-comment-block").show(),$CQ("#"+c).attr("value",""),$CQ("#"+c+"-comment-block").show(),$CQ("[id$\x3d-signed-in-text]").hide(),$CQ("[id$\x3d-signed-in-user]").text("")):($CQ("[id$\x3d-reply-button]").show(),$CQ("[id$\x3d-reply-arrow]").show(),$CQ("#"+a+"-comment-block").hide(),$CQ("#"+a).attr("value",k),$CQ("#"+l+"-comment-block").hide(),$CQ("#"+c+"-comment-block").hide(),$CQ("[id$\x3d-signed-in-user]").text(f),$CQ("[id$\x3d-signed-in-text]").show())}}
(function(c){window.CQ_Analytics=window.CQ_Analytics||{};var d=window.CQ_Analytics,f=c.Model.extend({modelName:"SubscriptionModel",events:{UPDATED:"subscribe:update",UPDATE_ERROR:"subscribe:updateError"},doToggle:function(a){var f=_.bind(function(f){f=f.response;"object"!=typeof f&&(f=JSON.parse(f));this.set("states",f.states);this.set("subscribed",f.subscribed);this.trigger(this.events.UPDATED,{model:this});f=this.get("states");var k=this.get("subscribed");"following"===a&&k&&f.following.selected&&
(_.isUndefined(window._satellite)?d.Sitecatalyst&&d.record({event:"SCFFollow",values:{functionType:c.Context.communityFunction,path:c.Context.path,type:c.Context.type,ugcTitle:c.Context.ugcTitle,siteTitle:c.Context.siteTitle,sitePath:c.Context.sitePath,groupTitle:c.Context.groupTitle,groupPath:c.Context.groupPath,user:c.Context.user},collect:!1,componentPath:c.constants.ANALYTICS_BASE_RESOURCE_TYPE}):window._satellite.track("communities-scf-follow"))},this),l=_.bind(function(a,d,g){c.log.error("error toggle follow state %o",
g)},this),p=this.get("url"),q=[],t=[];$CQ.each(this.get("states"),function(c,d){d=d.selected;"unfollow-all"==a?d=!1:c==a&&(d=!d);q.push(c);t.push(d.toString())});$CQ.ajax(p,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:{":operation":"social:updatesubscriptions",types:q,states:t,subscribedId:this.get("subscribedId")},success:f,error:l})}}),a=c.View.extend({viewName:"SubscriptionView",init:function(){this.listenTo(this.model,this.model.events.UPDATED,this.update);this.listenTo(this.model,
this.model.events.UPDATE_ERROR,this.showError)},handleClick:function(a){a=a.currentTarget.getAttribute("data_type");this.model.doToggle(a);$("#followDropdownMenu").attr("aria-expanded","false")},toggle:function(a){"false"==$("#followDropdownMenu").attr("aria-expanded")?$("#followDropdownMenu").attr("aria-expanded","true"):$("#followDropdownMenu").attr("aria-expanded","false")},update:function(){this.render()}});c.Subscription=f;c.SubscriptionView=a;c.registerComponent("social/subscriptions/components/hbs/subscriptions",
c.Subscription,c.SubscriptionView)})(SCF);
(function(c,d,f,a,l){window.CQ_Analytics=window.CQ_Analytics||{};var k=CQ_Analytics,n=[],p=a.Model.extend({modelName:"CommentSystemModel",relationships:{items:{collection:"CommentList",model:"CommentModel"}},createOperation:"social:createComment",MOVE_OPERATION:"social:moveComment",getCustomProperties:function(b,a){return d.extend(b,a)},events:{MOVED:"comment:moved",MOVE_ERROR:"comment:moveError",ADD:"comment:added",ADD_ERROR:"comment:adderror"},_fixCachedProperties:function(){if(a.hasOwnProperty("Session")&&null!==
a.Session){var b=a.Session.checkIfUserCanPost(this.attributes.id);this.attributes.mayPost=b;this.fixCachedProperties();this.cacheFixed=!0;this.trigger("model:cacheFixed",this)}},fixCachedProperties:function(){},constructor:function(b,h){a.Model.prototype.constructor.apply(this,[b,h]);if(a.Session.isReady())this._fixCachedProperties();else a.Session.on("model:loaded",d.bind(this._fixCachedProperties,this))},shouldCommentBeAddedToList:function(b){return!0},addCommentSuccess:function(b){b=new a.Models[this.constructor.prototype.relationships.items.model](b.response);
b.get("isVisible")||b.get("draft")||this.view.showUGCLimitDialog(null,!0);b.attributes.approved?this.shouldCommentBeAddedToList(b)&&window.location.reload():(this.trigger(this.events.ADD,{model:this,newItem:b}),a.Util.announce(this.events.ADD,b.attributes))},addComment:function(b,h,x){c(".scf-attachment-error").remove();h=d.bind(this.addCommentSuccess,this);x=d.bind(function(b,a,h){if(401==b.status)b=$($(".scf-js-site-title")[0]).attr("href"),window.location.href="http://"+location.host+b.replace(".html",
"/signin.html");else{if(500==b.status)return b=c(".scf-composer-block")[0],null===b&&(b=c(document.body)),c('\x3cdiv class\x3d"scf-attachment-error"\x3e\x3ch3 class\x3d"scf-js-error-message"\x3eServer error. Please try again.\x3c/h3\x3e\x3cdiv\x3e').appendTo(b),!1;this.trigger(this.events.ADD_ERROR,this.parseServerError(b,a,h))}},this);var w,e="undefined"!==typeof b.files,g="undefined"!==typeof b.tags;e?(window.FormData&&(w=new FormData),w&&(c.each(b.files,function(b,a){w.append("file",a)}),w.append("id",
"nobot"),w.append(":operation",this.createOperation),delete b.files,g&&c.each(b.tags,function(b,a){w.append("tags",a)}),delete b.tags,c.each(b,function(b,a){w.append(b,a)}))):(w={id:"nobot",":operation":this.createOperation},d.extend(w,b),w=this.getCustomProperties(w,b));c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",processData:!e,contentType:e?!1:"application/x-www-form-urlencoded; charset\x3dUTF-8",xhrFields:{withCredentials:!0},data:this.addEncoding(w),
success:h,error:x})},addIncludeHint:function(b){d.extend(b,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":this.get("resourceType")})},move:function(b){var h=d.bind(function(b,a,h){this.trigger(this.events.MOVE_ERROR,{error:h})},this),x=d.bind(this.addCommentSuccess,this);c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:{":operation":this.MOVE_OPERATION,resourcePath:b.resourcePath,parentPath:b.parentPath},
success:x,error:h})},translateAll:function(b){a.CommentSystem.thisRef=this;void 0===this.get("showingTranslationAll")&&this.set("showingTranslationAll",!1);var h=this.get("items");b=[];b.push(this);for(var c in h.models)b.push(h.models[c]);var d=0;h=[];var e=function(){d--;0>=d&&(a.CommentSystem.thisRef.set("translateAllInProgress",!1),!0===a.CommentSystem.thisRef.get("showingTranslationAll")?a.CommentSystem.thisRef.set("showingTranslationAll",!1):a.CommentSystem.thisRef.set("showingTranslationAll",
!0),a.CommentSystem.thisRef.view&&a.CommentSystem.thisRef.view.render())};if(!1===this.get("showingTranslationAll")){for(c in b)b[c].get("canTranslate")&&!b[c].get("showingTranslation")&&(d++,h.push(b[c]));0<d&&(this.set("translateAllInProgress",!0),this.view&&this.view.render());if(0===d){this.set("showingTranslationAll",!0);this.view&&this.view.render();return}}else{for(c in b)b[c].get("canTranslate")&&b[c].get("showingTranslation")&&(d++,h.push(b[c]));if(0===d){this.set("showingTranslationAll",
!1);this.view&&this.view.render();return}}for(c in h)h[c].translate(e)},refetchUsingSort:function(b,h){var c=this.get("pageInfo"),e=this.get("properties"),g=d.intersection(e.sortBy,["views","posts","follows","likes"]);h||(h="DESC");b="newest"===b?"added":b;b=0<g.length&&d.contains(g,b)?this.get("id")+a.constants.SOCIAL_SELECTOR+"."+b+"_"+e.timeSelector+".":this.get("id")+a.constants.SOCIAL_SELECTOR+"."+b+".";b=b+0+".";b="DESC"==h?b+Math.abs(c.pageSize):b+"-"+Math.abs(c.pageSize);this.url=b+=a.constants.JSON_EXT;
this.reload()},getSortOrder:function(){var b=[];b.push({text:CQ.I18n.get("Newest"),value:"newest"});b.push({text:CQ.I18n.get("Oldest"),value:"added"});b.push({text:CQ.I18n.get("Last Updated"),value:"latestActivityDate_dt"});b.push({text:CQ.I18n.get("Most Viewed"),value:"views"});b.push({text:CQ.I18n.get("Most Active"),value:"posts"});b.push({text:CQ.I18n.get("Most Followed"),value:"follows"});b.push({text:CQ.I18n.get("Most Liked"),value:"likes"});return b}}),q=a.View.extend({viewName:"CommentSystem",
className:"comment-system",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",getOtherProperties:function(){return{}},PAGE_EVENT:"pageComments",PAGE_URL_PREFIX:"comments",init:function(){this.listenTo(this.model,this.model.events.ADD,this.update);this.listenTo(this.model,this.model.events.ADD_ERROR,this.showErrorOnAdd);this.listenTo(this.model.get("items"),"comment:deleted",function(b){this.model.set({totalSize:this.model.get("totalSize")-1});a.Util.mayCall(this.model.get("items"),"remove")&&
this.model.get("items").remove(b.model);this.render()});this.listenTo(this.model,this.model.events.ADD,this.recordCreate);this.listenTo(a.Router,"route:"+this.PAGE_EVENT,this.paginate);a.Router.route(/^(.*?)\.([0-9]*)\.(-?[0-9]*)\.htm.*?$/,this.PAGE_EVENT);this.model.view=this},afterRender:function(){window.scrollTo(0,0);var b=this.model.get("pageInfo"),a=this.model.get("properties"),c=this.model.get("configuration"),e,g;b&&b.sortIndex?g=e=b.sortIndex:c.sortFields[0]&&(e=Object.getOwnPropertyNames(c.sortFields[0]).toString());
e||(e="");a=a&&a.sortFieldOrder?a.sortFieldOrder:"desc";a="undefined"!==typeof Storage&&localStorage.getItem("sortOrderLs")?localStorage.getItem("sortOrderLs"):a;a=a.toLowerCase();(b=b.orderReversed)||"asc"!==a||"added"!==e||(b=!0);a=e.split("_")[0];d.contains(["views","posts","likes","follows"],a)&&(e=this.model.get("pageInfo").sortIndex=a);if(e){switch(!0){case "newest"===e||"added"===g&&!b||"added"===e&&!b:e=CQ.I18n.get("Newest");break;case "latestActivityDate_dt"===e:e=CQ.I18n.get("Last Updated");
break;case "added"===e:e=CQ.I18n.get("Oldest");break;case "views"===e:e=CQ.I18n.get("Most Viewed");break;case "posts"===e:e=CQ.I18n.get("Most Active");break;case "follows"===e:e=CQ.I18n.get("Most Followed");break;case "likes"===e:e=CQ.I18n.get("Most Liked");break;default:e=CQ.I18n.get("Sort By")}this.$el.find(".scf-sort-btngrp-btnlabel").text(e);if(0<window.location.href.indexOf("filter\x3dpage")){e=window.location.href.split("filter\x3dpage+has+")[1];null==e&&(e=window.location.href.split("filter\x3dpage%20has%20")[1]);
var f=null;g=null;if(0<e.indexOf("/")){e=e.substring(0,e.indexOf("/"));f=$("li[data-component-id$\x3d"+e+"]").find(".scf-comment-data")[0];g=$(f).offset().top-50;var r=$(f).siblings(".scf-load-more");$("html, body").animate({scrollTop:g},1E3,"linear").promise().then(function(){$(r).effect("highlight",{},5E3)})}else f=$("li[data-component-id$\x3d"+e+"]").find(".scf-comment-data")[0],g=$(f).offset().top-50,$("html, body").animate({scrollTop:g},1E3,"linear").promise().then(function(){$(f).effect("highlight",
{},5E3)})}}},recordCreate:function(){d.isUndefined(window._satellite)?k.Sitecatalyst&&k.record({event:this.CREATE_EVENT,values:{functionType:a.Context.communityFunction?a.Context.communityFunction:this.COMMUNITY_FUNCTION,path:a.Context.path?a.Context.path:this.model.get("id"),type:a.Context.type?a.Context.type:this.model.get("resourceType"),ugcTitle:a.Context.ugcTitle,siteTitle:a.Context.siteTitle?a.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:a.Context.sitePath?a.Context.sitePath:this.sitePath,
groupTitle:a.Context.groupTitle,groupPath:a.Context.groupPath,user:a.Context.user?a.Context.user:a.Session.get("authorizableId")},collect:!1,componentPath:a.constants.ANALYTICS_BASE_RESOURCE_TYPE}):window._satellite.track("communities-scf-create")},paginate:function(){var b=a.config.urlRoot+this.model.get("id")+a.constants.SOCIAL_SELECTOR+".",c=this.model.get("pageInfo"),e=this.model.get("configuration");c=c&&!d.isEmpty(c.sortIndex)?c.sortIndex:"";e=e&&e.analyticsTimeSelector?e.analyticsTimeSelector:
"total_tl";var g=arguments[1],f=arguments[2],m=3>=arguments.length?null:arguments[3];d.contains(["views","posts","likes","follows"],c)&&(c=c+"_"+e);b=3>=arguments.length?d.isEmpty(c)?b+g+"."+f+a.constants.JSON_EXT:b+c+"."+g+"."+f+a.constants.JSON_EXT:b+"index."+g+"."+f+"."+m+a.constants.JSON_EXT;this.model.url=b+window.location.search;this.model.reload()},update:function(){this.files=void 0;this.render()},requiresSession:!0,showErrorOnAdd:function(b){if("401"==b.details.status.code){var a=$($(".scf-js-site-title")[0]).attr("href");
window.location.href="http://"+location.host+a.replace(".html","/signin.html")}else b.details.status.message=CQ.I18n.get("Comment text is empty"),"400"==b.details.status.code?b.details.status.message=CQ.I18n.get("Required fields are missing"):this.isExceptionOnUGCLimit(b)?(b.details.status.message=CQ.I18n.get("Exceeded contribution limit"),this.showUGCLimitDialog(b.details.error.message)):b.details.status.message=CQ.I18n.get("Server error occurred. Please try again later."),this.addErrorMessage(this.$el.find(".scf-js-composer-block input[type\x3d'text'], textarea").first(),
b);this.log.error(b)},isExceptionOnUGCLimit:function(b){return b.details&&b.details.error&&(b=b.details.error)&&"com.adobe.cq.social.scf.OperationException"===b["class"]&&0<=b.message.indexOf("Exceeded contribution limit")?!0:!1},showUGCLimitDialog:function(b,d){c(".scf-comment-ugclimitdialog").length||(b=a.CommentSystemView.templates.ugcLimitDialog,b=this.compileTemplate(b),b=c(b(this.getContextForTemplate())),c(b).appendTo(this.$el));b=CQ.I18n.get("We are sorry, but you are limited to the number of content that you can create. You may contact a community manager or moderator.");
d?(c(".scf-comment-ugclimitdialog-title").text(CQ.I18n.get("Content Notice")),c(".scf-comment-ugclimitdialog-text").text(CQ.I18n.get("Your contribution has been submitted. It will appear on the site once approved by a moderator"))):c(".scf-comment-ugclimitdialog-text").text(b);c(".scf-comment-ugclimitdialog").modal("show")},hideError:function(){},expandComposer:function(){this.$el.find(".scf-js-composer-block:first").removeClass("scf-is-collapsed");var b=this.$el.find(".scf-js-composer-block"),a=
this.getField("message"),c=CQ.I18n.get("Write a comment"),d=a.substring(0,c.length);c==d&&this.setField("message","");b.is(":visible")?""===a&&this.setField("message",""):(this.files=void 0,this.$el.find(".scf-attachment-list").first().empty());this.focus("message")},cancelComposer:function(){this.$el.find(".scf-js-composer-block:first").addClass("scf-is-collapsed");this.files=void 0;c(".scf-js-composer-att").empty();this.setField("message","");this.clearErrorMessages()},toggleComposer:function(b,
a){c(".scf-attachment-error").remove()},addCommentDraft:function(b){var a=this.extractCommentData(b);a.isDraft=!0;return this.addToCommentModel(a,b)},addToCommentModel:function(b,a){this.model.addComment(b);a.target&&a.preventDefault();return!1},addComment:function(b){var a=this.extractCommentData(b);return!1===a?!1:this.addToCommentModel(a,b)},extractCommentData:function(b){b=this.getForm("new-comment");if(null===b||b.validate()){b=this.getField("message");var c=this.getField("tags"),e=[];void 0!=
this.model.get("editMentions")&&(e=this.model.get("editMentions"));b=d.extend(this.getOtherProperties(),{message:b,tags:c,mentions:e});a.Session.get("loggedIn")||(b.userIdentifier=this.getField("anon-name"),b.email=this.getField("anon-email"),b.url=this.getField("anon-web"));"undefined"!==typeof this.files&&(b.files=this.files);return b}return!1},navigate:function(b){var h=window.location.protocol+"//"+window.location.host,e=c(b.currentTarget).data("page-suffix"),g=this.model.get("pageInfo"),f=g.basePageURL,
m=window.location.search;0<m.indexOf("filter\x3dpage")&&(m="");var r=window.location.pathname;var k=0>r.lastIndexOf(".html")?r.substr(r.length):r.substr(r.lastIndexOf(".html")+5);var y=/(.*)\.(\w*)?\.(\d*)?\.(\d*)?\.html(\/.*)?/,n=/(.*)\.(\w*)?\.html(\/.*)?/,p=/(.*)\.html(\/.*)?/;if(d.isUndefined(f)||null===f)f=r,(y=y.exec(f))?f=y[1]+"."+y[2]:(y=n.exec(f))?f=y[1]+"."+y[2]:(y=p.exec(f),f=y[1]);-1!=(h+l.HTTP.getContextPath()).indexOf(a.config.urlRoot)?(b=f+"."+e+".html"+k,b=d.isEmpty(m)?b:b+m,f+".html"==
r&&0>m.indexOf("filter\x3dpage")&&(g=f+"."+g.previousSuffix+".html"+k,g=d.isEmpty(m)?g:g+m,a.Router.navigate(g,{trigger:!1})),a.Router.navigate(b,{trigger:!0})):(e=$(b.currentTarget).data("pageSuffix"),m=e.split("."),null!==g.sortIndex?this.paginate(f,m[0],m[1],g.sortIndex):this.paginate(f,m[0],m[1]))},renderAttachmentList:function(b){b.preventDefault();"undefined"==typeof this.files&&(this.files=[]);this.files.push.apply(this.files,b.target.files);b=c(".scf-js-composer-att");b.empty();for(var a=
0;a<this.files.length;a++){var e=this.files[a];e=c('\x3cli class\x3d"scf-is-attached"\x3e'+d.escape(e.name)+" - "+e.size+" bytes\x3c/li\x3e");b.append(e)}},openAttachmentDialog:function(b){a.Util.mayCall(b,"preventDefault")&&b.preventDefault();this.$el.find("input[type\x3d'file']").first().click()},translateAll:function(){this.model.translateAll()},toggle:function(b){"false"==b.currentTarget.getAttribute("aria-expanded")?b.currentTarget.setAttribute("aria-expanded","true"):b.currentTarget.setAttribute("aria-expanded",
"false")},refetchBasedOnSort:function(b){b=c(b.target).find(".scf-sort-type").addBack(".scf-sort-type");var a=b.data("sort-field"),d=b.data("sort-order");if("undefined"!==typeof Storage)localStorage.setItem("sortOrderLs",d);else throw Error("Sorry, your browser does not support Web Storage...");this.$el.find(".scf-sort-btngrp-btnlabel").text(b.text());this.model.refetchUsingSort(a,d)}}),t=a.Model.extend({modelName:"CommentModel",DELETE_OPERATION:"social:deleteComment",UPDATE_OPERATION:"social:updateComment",
CREATE_OPERATION:"social:createComment",EDIT_TRANSLATION_OPERATION:"social:editTranslation",CHANGESTATE_OPERATION:"social:changeState",events:{ADDED:"comment:added",UPDATED:"comment:updated",DELETED:"comment:deleted",ADD_ERROR:"comment:addError",UPDATE_ERROR:"comment:updateError",DELETE_ERROR:"comment:deleteError",TRANSLATED:"comment:translated",TRANSLATE_ERROR:"comment:translateError"},initialize:function(){this.isTranslationPresent()&&(this.set("showingTranslation",!0),a.Comment.isSmartRenderingOn=
!0);this.on("change",function(){!0===a.Comment.isSmartRenderingOn&&void 0===this.get("showingTranslation")&&this.isTranslationPresent()&&this.set("showingTranslation",!0)})},_fixCachedProperties:function(){if(this._isReady){if(this.off("model:loaded",d.bind(this._fixCachedProperties,this)),a.hasOwnProperty("Session")&&null!==a.Session){var b=this.attributes.isFlaggedByUser,c=this.attributes.approved,e=this.attributes.moderatorActions||{},g=a.Session.attributes.loggedIn,f=d.isUndefined(a.Session.attributes.id)?
"":a.Session.attributes.id.substr(a.Session.attributes.id.lastIndexOf("/")+1);f=(this.attributes.author||!1)&&a.Session.attributes.loggedIn&&(this.attributes.author.id===a.Session.attributes.id||(this.attributes.properties||!1)&&this.attributes.properties.composedBy===f);var m=this.attributes.moderatorStatus&&this.attributes.moderatorStatus.hasOwnProperty("isFlagged")?this.attributes.moderatorStatus.isFlagged:!1,r=this.attributes.moderatorStatus&&this.attributes.moderatorStatus.hasOwnProperty("isSpam")?
this.attributes.moderatorStatus.isSpam:!1,k=a.Session.checkIfModeratorFor(this.attributes.sourceComponentId);e.canAllow=k&&!this.attributes.isClosed&&(r||m||!this.attributes.approved);e.canDeny=(this.attributes.configuration||!1)&&k&&!r&&this.attributes.configuration.isDenyAllowed;e.canClose=(this.attributes.configuration||!1)&&k&&this.attributes.topLevel&&this.attributes.configuration.isCloseAllowed;e.canFlag=a.Session.attributes.mayReply&&!this.attributes.isClosed&&!b&&g&&c&&!f&&!r&&!m&&this.attributes.configuration.isFlaggingAllowed;
this.attributes.canEdit=k||(this.attributes.configuration||!1)&&f&&this.attributes.configuration.isEditAllowed&&!this.attributes.isClosed;this.attributes.canDelete=k||(this.attributes.configuration||!1)&&f&&this.attributes.configuration.isDeleteAllowed&&!this.attributes.isClosed;this.attributes.canReply=a.Session.attributes.mayReply&&(this.attributes.configuration||!1)&&this.attributes.configuration.isReplyAllowed&&!this.attributes.isClosed;this.attributes.moderatorActions=e;this.fixCachedProperties(k);
this.cacheFixed=!0;this.trigger("model:cacheFixed",this)}}else this.on("model:loaded",d.bind(this._fixCachedProperties,this))},fixCachedProperties:function(b){},constructor:function(b,c){a.Model.prototype.constructor.apply(this,[b,c]);if(a.Session.isReady())this._fixCachedProperties();else a.Session.on("model:loaded",d.bind(this._fixCachedProperties,this))},remove:function(){var b=d.bind(function(b,a,c){this.trigger(this.events.DELETE_ERROR,this.parseServerError(b,a,c))},this),e=d.bind(function(b){var a=
b=1;this.attributes.topic||this.attributes.topLevel||(b=this.collection.parent.attributes.totalSize,a=this.collection.parent.attributes.items.length,this.collection.parent.set("totalSize",b-1));--b;this.trigger("destroy",this);1==a&&0!==$('a[class\x3d"scf-page scf-currentPage"]').length?(b=$('a[class\x3d"scf-page scf-currentPage"]').data("page-suffix"),a=b.toString().split("."),0!==a[0]&&(a=parseInt(a[0],10)-parseInt(a[1],10)+"."+a[1],window.location.href=window.location.href.replace(b,a))):this.attributes.topic||
0!=b%this.attributes.configuration.pageSize||location.reload();this.trigger(this.events.DELETED,{model:this})},this);c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:{":operation":this.DELETE_OPERATION},success:e,error:b})},saveEditTranslation:function(){var b=d.bind(function(b,a,c){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(b,a,c))},this),e=d.bind(function(b){this.reset(b.response,{silent:!0});this.set("showingTranslation",
!0,{silent:!0});this.set("editTranslationInProgress",!1,{silent:!0});"side"===this.get("translationDisplay")&&this.set("displaySideBySide",!0,{silent:!0});this.get("isVisible")?this.trigger(this.events.UPDATED,{model:this}):(this.trigger(this.events.DELETED,{model:this}),this.trigger("destroy",this))},this),g={translatedText:this.get("message"),id:"nobot",":operation":this.EDIT_TRANSLATION_OPERATION};c.ajax(a.config.urlRoot+this.get("id")+a.constants.TRANSLATE_URL_EXT,{dataType:"json",type:"POST",
xhrFields:{withCredentials:!0},data:this.addEncoding(g),success:e,error:b})},saveEdits:function(){var b=d.bind(function(b,a,c){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(b,a,c))},this),e=d.bind(function(b){this.reset(b.response,{silent:!0});if(this.get("isVisible"))this.trigger(this.events.UPDATED,{model:this});else if(this.get("draft"))this.trigger(this.events.UPDATED,{model:this});else if(this.get("approved"))this.trigger(this.events.DELETED,{model:this}),this.trigger("destroy",
this);else{this.view.showUGCLimitDialog(null,!0);var a=this;b=new MutationObserver(function(b){$(".scf-comment-ugclimitdialog").is(":hidden")&&(a.get("topLevel")?location.href=a.get("pageInfo").basePageURL+".html":window.location.reload(),this.disconnect())});var c=document.querySelector(".scf-comment-ugclimitdialog");b.observe(c,{attributes:!0})}},this),g=null,f=this.get("files"),k="undefined"!==typeof f,m=this.get("tags"),r=this.get("editMentions");k&&(window.FormData&&(g=new FormData),g&&(c.each(f,
function(b,a){g.append("file",a)}),g.append("id","nobot"),g.append(":operation",this.UPDATE_OPERATION),g.append("message",this.get("message")),c.each(this.getCustomProperties(),function(b,a){g.append(b,a)}),m&&c.each(m,function(b,a){g.append("tags",a)})));null===g&&(g={message:this.get("message"),id:"nobot",":operation":this.UPDATE_OPERATION},m&&(g.tags=m),r&&(g.mentions=r),n&&(g.attachmentsTobeDeleted=n),g=d.extend(this.getCustomProperties(),g));c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,
{dataType:"json",processData:!k,contentType:k?!1:"application/x-www-form-urlencoded; charset\x3dUTF-8",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(g),success:e,error:b})},loadMore:function(){var b=this.get("pageInfo").nextPageURL;-1!==b.indexOf(".html",this.length-5)?b=b.substr(0,b.lastIndexOf(".html"))+".json":-1!==b.indexOf(".null",this.length-5)&&(b=b.substr(0,b.lastIndexOf(".null"))+".json");var a=this;this.constructor.find(b,function(b){var c=b.get("items");b=b.get("pageInfo");
a.set("pageInfo",b);a.get("items").add(c.models,{silent:!0,merge:!0});a.trigger(a.events.UPDATED,{model:a})},!0)},getCustomProperties:function(){return{}},isTranslationPresent:function(){var b=this.get("translationDescription");return!d.isEmpty(b)},translate:function(b){if(!0!==this.get("translationAjaxInProgress"))if(this.isTranslationPresent()){var e=!0;!0===this.get("showingTranslation")&&(e=!1);this.set({showingTranslation:e});this.trigger(this.events.UPDATED,{model:this});b&&b()}else{this.set("translationAjaxInProgress",
!0);e=d.bind(function(b,a,c){this.set("translationAjaxInProgress",!1);this.trigger(this.events.TRANSLATE_ERROR,this.parseServerError(b,a,c))},this);var g=d.bind(function(a){this.set("translationAjaxInProgress",!1);this.set({showingTranslation:!0});this.set({translationDescription:a.translationDescription});this.set({translationAttribution:a.translationAttribution});this.set({translationTitle:a.translationTitle});"side"===this.get("translationDisplay")&&this.set("displaySideBySide",!0,{silent:!0});
this.trigger(this.events.UPDATED,{model:this});b&&b()},this),f=a.config.urlRoot+this.get("id")+a.constants.TRANSLATE_URL_EXT;c.ajax({type:"GET",url:f,dataType:"json",success:g,error:e});this.trigger(this.events.UPDATED,{model:this})}},addReply:function(b,e,g){e=d.bind(function(b){b=b.response;var c=this.constructor.prototype.relationships.items.model,e=a.Models[c];if(d.isUndefined(e))this.log.error("reply model not found: "+c);else{c=new e(b);if(c.get("isVisible")||c.get("draft")){if(this.attributes.items.length<
this.attributes.configuration.pageSize){c._isReady=!0;c.set("_isNew",!0);var h=this.get("items"),g=!1;h||(h=new (a.Collections[this.constructor.prototype.relationships.items.collection]||f.Collection),h.model=this.constructor,h.parent=this,g=!0);h.push(c);e=this.get("totalSize");g&&this.set("items",h);this.set("totalSize",e+1);c.constructor.prototype._cachedModels[b.id]=c}else window.location.href=window.location.origin+this.attributes.friendlyUrl+"?filter\x3dpage+has+"+b.id.substring(b.id.lastIndexOf("/")+
1);$(".scf-social-console-textbox-tooltip").show().delay(5E3).hide(0)}else this.view.showUGCLimitDialog(null,!0);this.trigger(this.events.ADDED,{model:this});a.Util.announce(this.events.ADDED,c.attributes)}},this);g=d.bind(function(b,a,d){if(401==b.status)b=$($(".scf-js-site-title")[0]).attr("href"),window.location.href="http://"+location.host+b.replace(".html","/signin.html");else{var e=c(".scf-composer-block")[0];null===e&&(e=c(document.body));if(500==b.status)return c('\x3cdiv class\x3d"scf-attachment-error"\x3e\x3ch3 class\x3d"scf-js-error-message"\x3e\x3c/h3\x3e\x3cdiv\x3e').appendTo(e),
e.lastChild.children[0].innerText=CQ.I18n.get("Server error. Please try again."),!1;if(404==b.status)return c('\x3cdiv class\x3d"scf-attachment-error"\x3e\x3ch3 class\x3d"scf-js-error-message"\x3e\x3c/h3\x3e\x3cdiv\x3e').appendTo(e),e.lastChild.children[0].innerText=CQ.I18n.get("Requested page does not exist anymore."),!1;this.trigger(this.events.ADD_ERROR,this.parseServerError(b,a,d))}},this);var h,x="undefined"!=typeof b.files;x?(window.FormData&&(h=new FormData),h&&(c.each(b.files,function(b,a){h.append("file",
a)}),h.append("id","nobot"),h.append(":operation",this.CREATE_OPERATION),delete b.files,c.each(b,function(b,a){h.append(b,a)}))):(h={id:"nobot",":operation":this.CREATE_OPERATION},d.extend(h,b));c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",processData:!x,contentType:x?!1:"application/x-www-form-urlencoded; charset\x3dUTF-8",xhrFields:{withCredentials:!0},data:this.addEncoding(h),success:e,error:g})},changeCommentState:function(b,e,g){e=d.bind(function(c){this.set("state",
b.toState);c=c.response;var e=this.constructor.prototype.relationships.items.model,h=a.Models[e];if(d.isUndefined(h))this.log.error("reply model not found: "+e);else{e=new h(c);e._isReady=!0;e.set("_isNew",!0);h=this.get("items");var g=!1;h||(h=new (a.Collections[this.constructor.prototype.relationships.items.collection]||f.Collection),h.model=this.constructor,h.parent=this,g=!0);h.push(e);var x=this.get("totalSize");g&&this.set("items",h);this.set("totalSize",x+1);e.constructor.prototype._cachedModels[c.id]=
e;this.trigger(this.events.ADDED,{model:this})}},this);g=d.bind(function(b,a,c){this.trigger(this.events.ADD_ERROR,this.parseServerError(b,a,c))},this);var h={id:"nobot",":operation":this.CHANGESTATE_OPERATION};d.extend(h,b);c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",processData:!0,contentType:"application/x-www-form-urlencoded; charset\x3dUTF-8",xhrFields:{withCredentials:!0},data:this.addEncoding(h),success:e,error:g})},flag:function(b,e){var h=d.bind(function(b,
a,c){this.log.error("error flagging comment "+c);this.trigger("comment:flagerror",{error:c})},this),g=d.bind(function(b){this.reset(b.response,{silent:!0});this.get("isVisible")?(this.trigger("comment:flagged",{model:this}),this.trigger(this.events.UPDATED,{model:this})):(this.trigger(this.events.DELETED,{model:this}),this.trigger("destroy",this))},this);b={id:"nobot",":operation":"social:flag","social:flagformtext":b,"social:doFlag":e};c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",
type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(b),success:g,error:h})},allow:function(){var b=d.bind(function(b,a,c){this.log.error("error allowing comment "+c);this.trigger("comment:allowerror",{error:c})},this),e=d.bind(function(b){this.reset(b.response);this.trigger("comment:allowed",{model:this});this.trigger(this.events.UPDATED,{model:this})},this);c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding({id:"nobot",
":operation":"social:allow"}),success:e,error:b})},resetChildren:function(){this.get("items").each(function(b){b.destroy()})},close:function(b){var e=d.bind(function(b,a,c){this.log.error("error closing/opening comment "+c);this.trigger("comment:closeopenerror",{error:c})},this),g=d.bind(function(b){this.resetChildren();this.reset(b.response);this.trigger("comment:closedOpened",{model:this});this.trigger(this.events.UPDATED,{model:this})},this);b={id:"nobot",":operation":"social:close","social:doClose":b?
"true":"false"};c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(b),success:g,error:e})},deny:function(){var b=d.bind(function(b,a,c){this.log.error("error denying comment "+c);this.trigger("comment:denyerror",{error:c})},this),e=d.bind(function(b){this.reset(b.response);this.trigger("comment:denied",{model:this});this.trigger(this.events.UPDATED,{model:this})},this);c.ajax(a.config.urlRoot+this.get("id")+
a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding({id:"nobot",":operation":"social:deny"}),success:e,error:b})},pin:function(){this.doPin(!0)},unpin:function(){this.doPin(!1)},doPin:function(b){var e="comment:pinerror";b||(e="comment:unpinerror");var g=d.bind(function(b,a,c){this.log.error("error pinunpin comment "+c);this.trigger(e,{error:c})},this),f=d.bind(function(b){this.reset(b.response);this.trigger(e,{model:this});this.trigger(this.events.UPDATED,
{model:this})},this);b={":operation":"social:pin","social:doPin":b};c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(b),success:f,error:g})},markFeatured:function(){this.makeFeatured(!0)},unmarkFeatured:function(){this.makeFeatured(!1)},makeFeatured:function(b){var e="Failed to mark as featured";b||(e="Failed to unmarked as featured");var g=d.bind(function(b,a,c){this.log.error("error toggle topic as featured "+
c);this.trigger(e,{error:c})},this),f=d.bind(function(b){this.reset(b.response);this.trigger(e,{model:this});this.trigger(this.events.UPDATED,{model:this})},this);b={":operation":"social:featured","social:markFeatured":b};c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(b),success:f,error:g})},addIncludeHint:function(b){for(var a=this,c=null;null!==a;)a.hasOwnProperty("collection")?a=a.collection:(c=a.parent.get("resourceType"),
a=null);d.extend(b,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":c})},deleteAttachment:function(b){var e=d.bind(function(b,a,c){this.log.error("error deleting attachment "+c);this.trigger("comment:deleteAttError",{error:c})},this),g=d.bind(function(a){a=this.get("attachments");a=d.omit(a,b);this.set({attachments:a})},this),f={attToRemove:b.substr(b.lastIndexOf("/")+1),":operation":"social:deleteCommentAttachment"};c.ajax(a.config.urlRoot+this.get("id")+a.constants.URL_EXT,{dataType:"json",
type:"POST",xhrFields:{withCredentials:!0},data:this.addEncoding(f),success:g,error:e})},relationships:{items:{collection:"CommentList",model:"CommentModel"},votes:{model:"VotingModel"}}}),v=a.View.extend({viewName:"Comment",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",isExceptionOnUGCLimit:q.prototype.isExceptionOnUGCLimit,showUGCLimitDialog:q.prototype.showUGCLimitDialog,init:function(){this.listenTo(this.model,this.model.events.ADDED,this.update);this.listenTo(this.model,this.model.events.ADD_ERROR,
this.showError);this.listenTo(this.model,this.model.events.UPDATED,this.commentViewUpdate);this.listenTo(this.model,this.model.events.UPDATE_ERROR,this.showError);this.listenTo(this.model,this.model.events.DELETED,this.removeView);this.listenTo(this.model,this.model.events.DELETE_ERROR,this.showError);this.listenTo(this.model,this.model.events.ADDED,this.recordCreate);this.model.view=this;this.model.isTranslationPresent()&&"side"===this.model.get("translationDisplay")&&this.model.set("displaySideBySide",
!0)},loadMore:function(b){b.preventDefault();this.model.loadMore()},removeView:function(){f.View.prototype.remove.apply(this,arguments);this.model.get("topLevel")&&!0===this.model.get("topLevel")&&(location.href=this.model.get("pageInfo").basePageURL+".html")},commentViewUpdate:function(){this.render()},update:function(){this.files=void 0;this.render()},recordCreate:function(){d.isUndefined(window._satellite)?k.Sitecatalyst&&k.record({event:this.CREATE_EVENT,values:{functionType:a.Context.communityFunction?
a.Context.communityFunction:this.COMMUNITY_FUNCTION,path:a.Context.path?a.Context.path:this.model.get("id"),type:a.Context.type?a.Context.type:this.model.get("resourceType"),ugcTitle:a.Context.ugcTitle,siteTitle:a.Context.siteTitle?a.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:a.Context.sitePath?a.Context.sitePath:this.sitePath,groupTitle:a.Context.groupTitle,groupPath:a.Context.groupPath,user:a.Context.user?a.Context.user:a.Session.get("authorizableId")},collect:!1,componentPath:a.constants.ANALYTICS_BASE_RESOURCE_TYPE}):
window._satellite.track("communities-scf-create")},afterRender:function(){this.model.unset("_isNew");var b=$(".generic-translation-all-button");b&&(!0!==this.model.get("canTranslate")||b.show()||b.show());var a=this.$el.find(".scf-js-attachments").not(this.$("[data-scf-component] .scf-js-attachments")),e=this;c().imagesLoaded&&a.imagesLoaded(function(){e.attachments=new SCFCards(a)})},showError:function(b){var a=this.$el.find(".scf-js-comment-reply-box:first textarea");this.log.error(b);if(this.isExceptionOnUGCLimit(b))this.showUGCLimitDialog(b.details.error.message),
b.details.status.message=CQ.I18n.get("Exceeded contribution limit");else if("400"==b.details.status.code)b.details.status.message=CQ.I18n.get("Required fields are missing");else if("401"==b.details.status.code.toString()){var c=$($(".scf-js-site-title")[0]).attr("href");window.location.href="http://"+location.host+c.replace(".html","/signin.html")}else"403"==b.details.status.code?(b=b||{},b.details.status.message||(b.details.status.message=CQ.I18n.get("Unknown Error."))):b.details.status.message=
CQ.I18n.get("Server error occurred. Please try again later.");this.addErrorMessage(a,b)},hideError:function(){},edittranslation:function(b){this.model.set("editTranslationInProgress",!0);b.stopPropagation();this.$el.find(".scf-js-comment-edit-box:first").toggle();this.$el.find(".scf-js-comment-msg:first").toggle();b=this.model.get("translationDescription");this.setField("editMessage",b);this.focus("editMessage")},translate:function(){this.model.translate()},addReply:function(b){var c=this.getField("replyMessage"),
e=[];void 0!=this.model.get("editMentions")&&(e=this.model.get("editMentions"));c=d.extend(this.getOtherProperties(!0),{message:c,mentions:e});a.Session.get("loggedIn")||(c.userIdentifier=this.getField("anon-name"),c.email=this.getField("anon-email"),c.url=this.getField("anon-web"));"undefined"!=typeof this.files&&(c.files=this.files);this.clearErrorMessages();this.model.addReply(c);b.preventDefault();return!1},addReplyFromData:function(b,c){a.Session.get("loggedIn")||(c.userIdentifier=this.getField("anon-name"),
c.email=this.getField("anon-email"),c.url=this.getField("anon-web"));"undefined"!=typeof this.files&&(c.files=this.files);this.clearErrorMessages();this.model.addReply(c);b.preventDefault();return!1},reply:function(b){b.stopPropagation();this.$el.find(".scf-js-comment-reply-box:first").toggle();this.focus("replyMessage");this.setField("replyMessage","")},remove:function(b){b.stopPropagation();b=this.$el.find(".comment-delete-box:first");this._closeModal=this.launchModal(b,CQ.I18n.get("Delete"))},
noDelete:function(b){b.stopPropagation();this._closeModal();this._closeModal=void 0},reallyDelete:function(b){b.stopPropagation();this.model.remove();this._closeModal();this._closeModal=void 0},edit:function(b){b.stopPropagation();this.model.set("editTranslationInProgress",!1);this.$el.find(".scf-js-comment-edit-box:first").toggle();this.$el.find(".scf-js-comment-msg:first").toggle();this.$el.find(".scf-comment-action").hide();b=this.model.get("message");this.model.getConfigValue("isRTEEnabled")||
(b=c("\x3cdiv/\x3e").html(b).text());var a=this.$el.find(".scf-js-edit-attachments").not(this.$("[data-scf-component] .scf-js-edit-attachments")),e=this;c().imagesLoaded&&a.imagesLoaded(function(){e.editableAttachments=new SCFCards(a)});-1!=b.indexOf('\x3ca id\x3d"renditionAnchor"')&&(b=b.replace(/\/renditions\//g,"/images/"));this.setField("editMessage",b);b=[];void 0!=this.model.get("properties").mentions&&(b=this.model.get("properties").mentions.concat());this.model.set("editMentions",b);this.focus("editMessage")},
save:function(b){var a=this.getData();this.saveOperation(b,a)},saveDraft:function(b){var a=this.getData();a.isDraft=!0;this.saveOperation(b,a)},publishDraft:function(b){var a=this.getData();this.saveOperation(b,a)},changeCommentState:function(b){var a=this.getField("message"),c=d.extend(this.getOtherProperties(),{message:a});this.clearErrorMessages();!1===d.isEmpty(a)&&this.model.changeCommentState(c);b.preventDefault();return!1},saveOperation:function(b,a){b.stopPropagation();b.preventDefault();
b=this.model.get("editTranslationInProgress");this.clearErrorMessages();this.model.set(a);b?this.model.saveEditTranslation():this.model.saveEdits();n.length=0;this.files=void 0;c(".scf-js-composer-att").empty();return!1},getData:function(){var b=this.getField("editMessage"),a=this.getField("editTags"),c=[];void 0!=this.model.get("editMentions")&&(c=this.model.get("editMentions"));b=d.extend(this.getOtherProperties(),{message:b,tags:a,mentions:c});"undefined"!=typeof this.files&&(b.files=this.files);
return b},cancelComposer:function(b){b.stopPropagation();this.clearErrorMessages();this.$el.find(".scf-js-comment-reply-box:first").toggle();this.files=void 0},cancel:function(b){b.stopPropagation();this.clearErrorMessages();this.$el.find(".scf-js-comment-edit-box:first").hide();if(b=this.model.changedAttributes())b=d.keys(b),b=d.pick(this.model.previousAttributes(),b),this.model.set(b);this.$el.find(".scf-js-comment-msg:first").show();this.$el.find(".scf-comment-action").show()},getOtherProperties:function(){return{}},
editFlagReason:function(b){b.preventDefault();b=this.$el.find(".scf-js-flagreason-box:first");this._closeDialog=this.launchModal(b,CQ.I18n.get("Flag"))},cancelFlagging:function(b){b.preventDefault();this._closeDialog();this._closeDialog=void 0},addFlagReason:function(b){b.preventDefault();b=this.getField("flagReason");if(0===b.length||"custom"===b)b=this.getField("customFlagReason");0!==b.length?this.model.flag(b,!0):this.model.flag("",!0);this._closeDialog();this._closeDialog=void 0},toggleFlag:function(b){b.preventDefault();
this.$el.find(".scf-js-toggleFlag-box:first").toggle()},removeFlag:function(b){b.preventDefault();this.model.flag(null,!1)},close:function(b){b.preventDefault();this.model.close(!0)},open:function(b){b.preventDefault();this.model.close(!1)},allow:function(b){b.preventDefault();this.model.allow()},deny:function(b){b.preventDefault();this.model.deny()},pin:function(b){b.preventDefault();this.model.pin()},unpin:function(b){b.preventDefault();this.model.unpin()},markFeatured:function(b){b.preventDefault();
this.model.markFeatured()},unmarkFeatured:function(b){b.preventDefault();this.model.unmarkFeatured()},getLastPath:function(){var b=this.model.get("id"),a=b.lastIndexOf("/");return a=b.slice(a+1)},renderAttachmentList:function(b){b.preventDefault();"undefined"==typeof this.files&&(this.files=[]);this.files.push.apply(this.files,b.target.files);b=c(".scf-js-composer-att");b.empty();for(var a=0;a<this.files.length;a++){var e=this.files[a];e=c('\x3cli class\x3d"scf-is-attached"\x3e'+d.escape(e.name)+
" - "+e.size+" bytes\x3c/li\x3e");b.append(e)}},openAttachmentDialog:function(b){a.Util.mayCall(b,"preventDefault")&&b.preventDefault();this.$el.find("input[type\x3d'file']").first().click()},toggleAttachmentOverlay:function(b){b=$(b.target).closest(".scf-js-comment-att");b.hasClass("scf-is-card-overlay-on")?b.removeClass("scf-is-card-overlay-on"):b.addClass("scf-is-card-overlay-on")},deleteAttachment:function(b){b=$(b.target).closest(".scf-js-comment-att").data("attachment-path");var a=b.substr(b.lastIndexOf("/")+
1);n.push(a);this.updateEditableAttachments({model:this.model,attachment:b})},updateEditableAttachments:function(b){this.$el.find('[data-attachment-path\x3d"'+b.attachment+'"]').remove();this.editableAttachments.redraw(!0)},confirmDeleteAttachment:function(b){$(b.target).closest(".scf-js-comment-att").addClass("scf-is-att-confirm-overlay-on")},cancelDeleteAttachment:function(b){$(b.target).closest(".scf-js-comment-att").removeClass("scf-is-att-confirm-overlay-on")}}),u=f.Collection.extend({collectionName:"CommentList"}),
g=a.Model.extend({modelName:"AuthorModel"}),e=a.View.extend({viewName:"Author",tagName:"div",className:"author"});a.Comment=t;a.CommentSystem=p;a.CommentView=v;a.CommentSystemView=q;a.CommentList=u;a.Author=g;a.AuthorView=e;a.registerComponent("social/commons/components/hbs/comments/comment",a.Comment,a.CommentView);a.registerComponent("social/commons/components/hbs/comments",a.CommentSystem,a.CommentSystemView)})($CQ,_,Backbone,SCF,Granite);
(function(c,d,f,a){a.CommentSystemView.templates=a.CommentSystemView.templates||{};a.CommentSystemView.templates.ugcLimitDialog='\x3cdiv class\x3d"modal fade scf-comment-ugclimitdialog" tabindex\x3d"-1" role\x3d"dialog"\x3e\x3cdiv class\x3d"modal-dialog" role\x3d"document"\x3e\x3cdiv class\x3d"modal-content"\x3e\x3cdiv class\x3d"modal-header"\x3e\x3cbutton type\x3d"button" onclick\x3d"$CQ(\'.scf-comment-ugclimitdialog\').hide();$CQ(\'body\').removeClass(\'modal-open\');$CQ(\'.modal-backdrop.fade.in\').remove();" class\x3d"close scf-modal-close" data-dismiss\x3d"modal" aria-label\x3d"Close"\x3e\x3cspan aria-hidden\x3d"true"\x3e\x26times;\x3c/span\x3e\x3c/button\x3e\x3ch2 class\x3d"modal-title scf-comment-ugclimitdialog-title"\x3e{{i18n "Content Notice"}}\x3c/h2\x3e\x3c/div\x3e\x3cdiv class\x3d"modal-body"\x3e\x3cdiv class\x3d"clearfix"\x3e\x3c/div\x3e\x3cp class\x3d"text-center scf-comment-ugclimitdialog-text"\x3e\x3c/p\x3e\x3c/div\x3e\x3cdiv class\x3d"modal-footer"\x3e\x3cbutton type\x3d"button" onclick\x3d"$CQ(\'.scf-comment-ugclimitdialog\').hide();$CQ(\'body\').removeClass(\'modal-open\');$CQ(\'.modal-backdrop.fade.in\').remove();" class\x3d"btn btn-primary" data-dismiss\x3d"modal"\x3e{{i18n "Close"}}\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3c!-- /.modal-content --\x3e\x3c/div\x3e\x3c!-- /.modal-dialog --\x3e\x3c/div\x3e\x3c!-- /.modal --\x3e'})($CQ,
_,Backbone,SCF);
(function(c,d,f,a){var l=window.location.protocol+"//"+window.location.host;c=a.View.extend({afterRender:function(){var a=this.model.get("subject"),c=this.model.get("message"),d=document.createElement("div");d.innerHTML=c;c=d.innerText||"";d=l+this.model.get("friendlyUrl");a="mailto:?Subject\x3d"+encodeURIComponent(a)+"\x26Body\x3d"+d+"%0D%0A%0D%0A"+encodeURIComponent(c)+"%0D%0A";this.$el.find(".scf-js-email-share").attr("href",a)},share:function(a){a=$(a.target).data("href")+l+this.model.get("friendlyUrl");window.open(a,
"_BLANK")}});a.ShareView=c;a.registerComponent("social/commons/components/hbs/socialshare",a.Model,a.ShareView)})($CQ,_,Backbone,SCF);
(function(c,d,f,a){window.CQ_Analytics=window.CQ_Analytics||{};var l=CQ_Analytics,k=a.CommentSystem.extend({modelName:"ForumModel",relationships:{items:{collection:"TopicList",model:"TopicModel"}},fixCachedProperties:function(){var c=a.Session.checkIfModeratorFor(this.get("id"));this.loadClipboard(c)},loadClipboard:function(a){var c=localStorage.getItem(t.prototype.FORUM_CLIPBOARD);null==c||d.isUndefined(c)?this.attributes.canPaste=!1:(c=JSON.parse(c),this.attributes.canPaste=a&&0<c.count,this.attributes.pasteCount=
c.count)},clearClipboard:function(){localStorage.removeItem(t.prototype.FORUM_CLIPBOARD);this.attributes.canPaste=!1;this.attributes.pasteCount=0;this.trigger(this.events.UPDATED,{model:this})},createOperation:"social:createForumPost",events:{ADD:"topic:added",ADD_ERROR:"topic:adderror",UPDATED:"topic:updated"}}),n=a.CommentSystemView.extend({viewName:"Forum",tagName:"div",className:"forum",FOLLOW_EVENT:"SCFFollow",VIEW_EVENT:"SCFView",COMMUNITY_FUNCTION:"Forum",init:function(){a.CommentSystemView.prototype.init.apply(this);
this.listenTo(this.model,this.model.events.UPDATED,this.update);a.Router.route(/^(.*?)\.index\.(.*)\.(-?[0-9]*)\.([0-9])*\.htm.*?$/,"pageTopics")},render:function(){a.CommentSystemView.prototype.render.apply(this);l.Sitecatalyst&&d.contains(l.Sitecatalyst.frameworkComponents,a.constants.ANALYTICS_BASE_RESOURCE_TYPE)&&this.$el.find(".scf-js-analytics-view-metrics").show()},getOtherProperties:function(){return{subject:this.getField("subject")}},PAGE_EVENT:"pageTopics",PAGE_URL_PREFIX:"topics",toggleComposer:function(c){var e=
this.$el.find(".scf-js-composer-block");e.toggleClass("scf-is-collapsed");this.$el.find(".scf-js-newtopic").toggleClass("scf-is-collapsed");e.is(":visible")?(this.focus("subject"),this.setField("message","")):(this.files=void 0,this.$el.find(".scf-attachment-list").first().empty());a.CommentSystemView.prototype.toggleComposer.apply(this,[c])},paste:function(){a.log.debug("pasting");var c=localStorage.getItem("scf:forum:clipboard");if(d.isUndefined(c)||null==c||0>=c.count)a.log.error("There are no clipboard items to paste");
else{var e=this.model.get("id");c=JSON.parse(c);d.each(c.itemsToMove,function(b){this.model.move({resourcePath:b.id,parentPath:e})},this);this.model.clearClipboard()}},clearClipboard:function(){a.log.debug("clear board");this.model.clearClipboard()},initAnalytics:function(){a.Context.communityFunction=this.COMMUNITY_FUNCTION;a.Context.path=this.model.id;a.Context.type=this.model.get("resourceType");a.Context.ugcTitle=this.model.get("subject")?this.model.get("subject"):"";d.isUndefined(window._satellite)?
l.Sitecatalyst&&(window.s.abort=!0,l.record({event:this.VIEW_EVENT,values:{functionType:a.Context.communityFunction?a.Context.communityFunction:this.COMMUNITY_FUNCTION,path:a.Context.path?a.Context.path:this.model.get("id"),type:a.Context.type?a.Context.type:this.model.get("resourceType"),ugcTitle:a.Context.ugcTitle,siteTitle:a.Context.siteTitle?a.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:a.Context.sitePath?a.Context.sitePath:this.sitePath,groupTitle:a.Context.groupTitle,groupPath:a.Context.groupPath,
user:a.Context.user?a.Context.user:a.Session.get("authorizableId")},collect:!1,componentPath:a.constants.ANALYTICS_BASE_RESOURCE_TYPE})):window._satellite.track("communities-scf-view")}}),p=a.Comment.extend({modelName:"PostModel",DELETE_OPERATION:"social:deleteForumPost",UPDATE_OPERATION:"social:updateForumPost",CREATE_OPERATION:"social:createForumPost",events:{ADDED:"post:added",UPDATED:"post:updated",DELETED:"post:deleted",ADD_ERROR:"post:addError",UPDATE_ERROR:"post:updateError",DELETE_ERROR:"post:deleteError",
TRANSLATED:"post:translated",TRANSLATE_ERROR:"post:translateError"},relationships:{items:{collection:"PostList",model:"PostModel"},votes:{model:"VotingModel"}},fixCachedProperties:function(){a.Session.attributes.loggedIn||(this.attributes.canReply=!1)}}),q=a.CommentView.extend({viewName:"Post",tagName:"li",className:"post",requiresSession:!0}),t=a.Comment.extend({modelName:"TopicModel",DELETE_OPERATION:"social:deleteForumPost",UPDATE_OPERATION:"social:updateForumPost",CREATE_OPERATION:"social:createForumPost",
FORUM_CLIPBOARD:"scf:forum:clipboard",events:{ADDED:"post:added",UPDATED:"topic:updated",DELETED:"topic:deleted",ADD_ERROR:"post:addError",UPDATE_ERROR:"topic:updateError",DELETE_ERROR:"topic:deleteError",TRANSLATED:"topic:translated",TRANSLATE_ERROR:"topic:translateError"},relationships:{items:{collection:"TopicList",model:"TopicModel"},votes:{model:"VotingModel"}},addToClipBoard:function(){"undefined"==typeof Storage&&a.log.error("Unable to move topic, please use a supported browser");var c=localStorage.getItem(this.FORUM_CLIPBOARD);
c=d.isUndefined(c)||null==c?{count:0,itemsToMove:{}}:JSON.parse(c);var e={id:this.id,title:this.get("title"),url:this.get("friendlyURL")};c.itemsToMove[this.id]=e;c.count++;this.attributes.hasBeenCut=!0;localStorage.setItem(this.FORUM_CLIPBOARD,JSON.stringify(c));this.trigger(this.events.UPDATED,{model:this})},removeFromClipboard:function(){"undefined"==typeof Storage&&a.log.error("Unable to move topic, please use a supported browser");var c=localStorage.getItem(this.FORUM_CLIPBOARD);c=JSON.parse(c);
c.count--;c.itemsToMove[this.id]=void 0;this.attributes.hasBeenCut=!1;localStorage.setItem(this.FORUM_CLIPBOARD,JSON.stringify(c));this.trigger(this.events.UPDATED,{model:this})},getCustomProperties:function(){return void 0!==this.get("subject")?{subject:this.get("subject")}:{}},fixCachedProperties:function(c){this.attributes.canReply=a.Session.attributes.loggedIn&&a.Session.attributes.mayReply&&!this.attributes.isClosed;this.attributes.moderatorActions.canMove=c&&!this.attributes.isClosed&&this.attributes.topLevel&&
this.attributes.configuration.moveAllowed;c=this.hasBeenCut();this.attributes.hasBeenCut=c},hasBeenCut:function(){var a=localStorage.getItem(this.FORUM_CLIPBOARD);if(null==a||d.isUndefined(a))return!1;a=JSON.parse(a);return d.isUndefined(a.itemsToMove[this.id])?!1:!0},translateAll:function(c){a.CommentSystem.prototype.translateAll.call(this,c)}}),v=a.CommentView.extend({viewName:"Topic",tagName:"li",className:"topic",requiresSession:!0,FOLLOW_EVENT:"SCFFollow",VIEW_EVENT:"SCFView",COMMUNITY_FUNCTION:"Forum",
init:function(){a.CommentView.prototype.init.apply(this);a.Router.route(/^(.*?)topic\.([0-9]*)\.(-?[0-9]*)\.htm.*?$/,"pagePosts");a.Router.route(/^(.*?)topic\.index\.(.*)\.(-?[0-9]*)\.([0-9])*\.htm.*?$/,"pagePosts");this.listenTo(a.Router,"route:pagePosts",this.paginate)},initAnalytics:function(){a.Context.communityFunction=this.COMMUNITY_FUNCTION;a.Context.path=this.model.id;a.Context.type=this.model.get("resourceType");a.Context.ugcTitle=this.model.get("subject")?this.model.get("subject"):"";d.isUndefined(window._satellite)?
l.Sitecatalyst&&(window.s.abort=!0,l.record({event:this.VIEW_EVENT,values:{functionType:a.Context.communityFunction?a.Context.communityFunction:this.COMMUNITY_FUNCTION,path:a.Context.path?a.Context.path:this.model.get("id"),type:a.Context.type?a.Context.type:this.model.get("resourceType"),ugcTitle:a.Context.ugcTitle,siteTitle:a.Context.siteTitle?a.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:a.Context.sitePath?a.Context.sitePath:this.sitePath,groupTitle:a.Context.groupTitle,groupPath:a.Context.groupPath,
user:a.Context.user?a.Context.user:a.Session.get("authorizableId")},collect:!1,componentPath:a.constants.ANALYTICS_BASE_RESOURCE_TYPE})):window._satellite.track("communities-scf-view")},afterRender:function(){a.CommentView.prototype.afterRender.apply(this);this.updateCrumbs();if(0<window.location.href.indexOf("filter\x3dpage")){var c=window.location.href.split("filter\x3dpage+has+")[1];null==c&&(c=window.location.href.split("filter\x3dpage%20has%20")[1]);var e=null,b=null;if(0<c.indexOf("/")){c=c.substring(0,
c.indexOf("/"));e=$("li[data-component-id$\x3d"+c+"]").find(".scf-comment-data")[0];b=$(e).offset().top-50;var d=$(e).find(".scf-load-more");$("html, body").animate({scrollTop:b},1E3,"linear").promise().then(function(){$(d).effect("highlight",{},5E3)})}else e=$("li[data-component-id$\x3d"+c+"]").find(".scf-comment-data")[0],b=$(e).offset().top-50,$("html, body").animate({scrollTop:b},1E3,"linear").promise().then(function(){$(e).effect("highlight",{},5E3)})}},updateCrumbs:function(){if(!this.$el.attr("data-scf-template")){var c=
[];c.push({title:CQ.I18n.get("Forum"),url:this.model.get("pageInfo").basePageURL+".html"});c.push({title:this.model.get("subject"),url:"",active:!0});a.Util.announce("crumbs",{crumbs:c})}},paginate:function(){var c=a.config.urlRoot+this.model.get("id")+a.constants.SOCIAL_SELECTOR+".",e=arguments[1],b=arguments[2],d=3>=arguments.length?null:arguments[3];this.model.url=3>=arguments.length?c+e+"."+b+a.constants.JSON_EXT:c+"index."+e+"."+b+"."+d+a.constants.JSON_EXT;this.model.reload()},navigate:function(d){window.scrollTo(0,
0);var e=window.location.protocol+"//"+window.location.host,b=$(".scf-page.scf-currentPage",this.$el).data("page-suffix");null!=d&&(b=c(d.currentTarget).data("page-suffix"));var f=this.model.get("pageInfo"),g=window.location.pathname;-1!=(e+Granite.HTTP.getContextPath()).indexOf(a.config.urlRoot)?(d=this.model.get("id"),d=d.substring(d.lastIndexOf("/")),f.basePageURL+".topic.html"+d+".html"==g&&0>window.location.href.indexOf("filter\x3dpage")&&a.Router.navigate(f.basePageURL+".topic."+f.previousSuffix+
".html"+d,{trigger:!1}),a.Router.navigate(f.basePageURL+".topic."+b+".html"+d,{trigger:!0})):(b=$(d.currentTarget).data("pageSuffix"),b=b.split("."),null!==f.sortIndex?this.paginate(f.basePageURL,b[0],b[1],f.sortIndex):this.paginate(f.basePageURL,b[0],b[1]))},edittranslation:function(c){a.CommentView.prototype.edittranslation.call(this,c);this.$el.find(".scf-js-topic-details").hide();c=this.model.get("translationTitle");this.setField("editSubject",c);this.focus("editSubject")},edit:function(c){a.CommentView.prototype.edit.call(this,
c);this.$el.find(".scf-js-topic-details").hide();c=this.model.get("subject");this.setField("editSubject",c);this.focus("editSubject")},cancel:function(c){a.CommentView.prototype.cancel.call(this,c);this.$el.find(".scf-js-topic-details").show()},cut:function(c){a.log.debug("cutting "+this.model.get("id"));this.model.addToClipBoard()},putBack:function(c){a.log.debug("putting back "+this.model.get("id"));this.model.removeFromClipboard()},getOtherProperties:function(){return{subject:this.getField("editSubject")}},
toggleComposerCollapse:function(a){$(a.currentTarget).closest(".scf-js-composer-block").toggleClass("scf-is-collapsed");this.focus("replyMessage");this.setField("replyMessage","")},translateAll:function(){this.model.translateAll()}}),u=f.Collection.extend({collectionName:"TopicList"});f=f.Collection.extend({collectionName:"PostList"});a.Post=p;a.Topic=t;a.Forum=k;a.TopicView=v;a.PostView=q;a.ForumView=n;a.TopicList=u;a.PostList=f;a.registerComponent("social/forum/components/hbs/post",a.Post,a.PostView);
a.registerComponent("social/forum/components/hbs/topic",a.Topic,a.TopicView);a.registerComponent("social/forum/components/hbs/forum",a.Forum,a.ForumView)})($CQ,_,Backbone,SCF);
(function(c,d,f,a){var l=a.Forum.extend({modelName:"JournalModel",relationships:{items:{collection:"BlogTopicList",model:"BlogTopicModel"}},createOperation:"social:createJournalComment",events:{ADD:"blogtopic:added",UPDATED:"topic:updated",ADD_ERROR:"blogtopic:adderror"},shouldCommentBeAddedToList:function(a){var b=this.view.listTypes.PUBLISHED,c=this.view.listTypes.PUBLISHED,e;a&&a.get("draft")&&(e=a.get("draft"))&&(c=(c=a.get("publishDate"))?new Date(c)>new Date?this.view.listTypes.SCHEDULED_LATER:
this.view.listTypes.DRAFTS:this.view.listTypes.DRAFTS);e=this.get("pageInfo").nextPageURL;"string"==typeof e&&-1<e.indexOf("filter")&&(b=0<e.indexOf(this.view.filterURLParam.SCHEDULED_LATER_URL_FILTER)||0<e.indexOf(this.view.filterURLParam.SCHEDULED_LATER_URL_FILTER_CHECK)?this.view.listTypes.SCHEDULED_LATER:this.view.listTypes.DRAFTS);if(c==b)return!0;this.trigger(this.events.ADD,{model:this,newItem:a});return!1}}),k=a.ForumView.extend({viewName:"Journal",COMMUNITY_FUNCTION:"Blog",eventBinded:!1,
filterURLParam:{DRAFT_URL_FILTER:"?filter\x3disDraft%20eq%20%27true%27\x26filter\x3dpublishDate%20eq%20null",SCHEDULED_LATER_URL_FILTER:"?filter\x3disDraft%20eq%20%27true%27\x26filter\x3dpublishDate%20ne%20null",SCHEDULED_LATER_URL_FILTER_CHECK:"?filter\x3disDraft+eq+%27true%27\x26filter\x3dpublishDate+ne+null"},listTypes:{PUBLISHED:"published",SCHEDULED_LATER:"scheduledLater",DRAFTS:"drafts"},PAGE_EVENT:"pageBlogArticles",afterRender:function(){a.ForumView.prototype.afterRender.apply(this);this.pageUrlSortHasFilterParams()&&
this.renderWithTemplate(!0)},init:function(){a.ForumView.prototype.init.apply(this);var c=this.model.get("resourceType");this.listenTo(this.model,"change:composedForValid",this.composedForChanged);this.listTemplateC=a.findTemplate(this.model.id,"journallists",c);a.Router.route(/^(.*?)\.([0-9]*)\.(-?[0-9]*)\.htm.*?$/,this.PAGE_EVENT)},getUrl:function(){var a=this.model.url;return"string"==typeof a?a:window.location.search?(a=this.model.url()||this.model.get("url"),a+window.location.search):(a=this.model.url())?
a:this.model.get("url")},composedForChanged:function(){this.model.get("composedForValid")?(this.$el.find(".scf-js-userfilter").removeClass("scf-error"),this.$el.find(".scf-js-invalid-user").addClass("scf-is-hidden").removeClass("scf-js-error-message"),this.$el.find(".scf-js-publish-btn").prop("disabled",!1)):(this.$el.find(".scf-js-userfilter").addClass("scf-error"),this.$el.find(".scf-js-invalid-user").addClass("scf-js-error-message").removeClass("scf-is-hidden"),this.$el.find(".scf-js-publish-btn").prop("disabled",
!0))},update:function(c){c&&c.newItem&&a.ForumView.prototype.update.apply(this)},activateTabs:function(a,b){this.$el.find(a).parent().addClass("active");this.$el.find(b).addClass("active")},pageUrlSortHasFilterParams:function(){var a=this.model.get("pageInfo");a=a?a.nextPageURL:"";return(a=CQ.shared.HTTP.getParameters(a,"filter"))&&0<a.length&&!d.contains(a,"filter\x3disDraft%20ne%20true")&&!d.contains(a,"isDraft+ne+true")?!0:!1},renderWithTemplate:function(a){var b=this.getUrl();this.$el.find(".tab-pane").empty();
var e=c(this.listTemplateC(this.getContextForTemplate(),{data:{parentView:this}})),f=!1;!d.isNull(this.model.url)&&0<b.indexOf(this.filterURLParam.SCHEDULED_LATER_URL_FILTER)?this.$el.find("#scf-js-laterPosts").empty().append(e):(this.$el.find("#scf-js-draftPosts").empty().append(e),f=!0);var g=this;d.each(this._childViews,function(a){g.renderChildView(a)});b=d.bind(function(){this.bindView();this._rendered=!0;this.afterRender&&!a&&this.afterRender();this.trigger("view:rendered",{view:this})},this);
c.when(this._renderedChildren).done(b);this.$el.find("li.scf-journal-tab").removeClass("active");this.$el.find(".tab-pane").removeClass("active");f?this.activateTabs(".scf-js-draftPosts","#scf-js-draftPosts"):this.activateTabs(".scf-js-laterPosts","#scf-js-laterPosts");return this},toggleComposer:function(c){this.$el.find(".scf-js-journal-tab").toggleClass("scf-is-hidden");this.$el.find(".scf-topic-list").toggleClass("scf-is-hidden");this.$el.find(".scf-pages").toggleClass("scf-is-hidden");var b=
this.$el.find(".scf-js-composer-block");b.hasClass("scf-is-collapsed")&&(this.eventBinded=!1);this.eventBinded||(this.bindDatePicker(c),this.eventBinded=!0);a.ForumView.prototype.toggleComposer.call(this,c,b)},bindDatePicker:function(a){a=function(a,e,f){0>=a.has("option").length&&c.each(d.range(e,f),function(b,c){c=CQ.I18n.get(10>c?"0"+c:c);a.append($("\x3coption/\x3e",{value:c,text:c}))})};this.$el.find(".scf-js-pubish-type .dropdown-menu li a").click(function(){$(".scf-js-pubish-type .btn:first-child").html('\x3cspan id\x3d"button_label"\x3e'+
$(this).text()+'\x3c/span\x3e \x3cspan class\x3d"caret"\x3e\x3c/span\x3e');$(".scf-js-pubish-type .btn:first-child").val($(this).text())});this.$el.find(".scf-js-event-basics-start-input").datepicker({changeMonth:!0,numberOfMonths:2,setDate:"0",beforeShow:function(a,c){$("#ui-datepicker-div").wrap("\x3cdiv class\x3d'scf-datepicker'\x3e\x3c/div\x3e")},onClose:function(a){c(".scf-event-basics-start-input").datepicker("option","minDate",a)}}).datepicker("setDate",new Date);a(this.$el.find(".scf-js-event-basics-start-hour"),
1,13);a(this.$el.find(".scf-js-event-basics-start-min"),0,60);p(new Date,this)},showDraftOption:function(a){this.$el.find(".scf-js-publish-time-input").addClass("scf-is-hidden");this.$el.find(".scf-js-save-draft-btn").show();this.$el.find(".scf-js-publish-btn").hide()},showPublishOption:function(a){this.$el.find(".scf-js-publish-time-input").removeClass("scf-is-hidden");this.$el.find(".scf-js-save-draft-btn").hide();this.$el.find(".scf-js-publish-btn").show()},showImmediatelyOption:function(a){this.$el.find(".scf-js-publish-time-input").addClass("scf-is-hidden");
this.$el.find(".scf-js-save-draft-btn").hide();this.$el.find(".scf-js-publish-btn").show()},getOtherProperties:function(){var a=this.getField("subject").trim(),b=$(this.$el.find(".scf-js-pubish-type \x3e button \x3e span")).text(),c=!1,f=null,g=!1;d.isEmpty(b)||b!=$(this.$el.find(".scf-js-pubish-type \x3e ul \x3e li \x3e a")[1]).text()?d.isEmpty(b)||b!=$(this.$el.find(".scf-js-pubish-type \x3e ul \x3e li \x3e a")[2]).text()||(g=c=!0,f=n(this.$el.find(".scf-js-event-basics-start-input").val(),this.$el.find(".scf-js-event-basics-start-hour").val(),
this.$el.find(".scf-js-event-basics-start-min").val(),this.$el.find(".scf-js-event-basics-start-time-ampm").val())):c=!0;a={subject:a,isDraft:c};g&&(a.isScheduled=!0,a.publishDate=f);this.model.getConfigValue("usingPrivilegedUsers")&&(f=this.getField("composedFor"),d.isEmpty(f)||(a.composedFor=f));this.eventBinded=!1;return a},fetchDrafts:function(){$(".scf-js-draftPosts").off("click");this.switchView(this.filterURLParam.DRAFT_URL_FILTER,".scf-js-draftPosts","#scf-js-draftPosts")},fetchLaterPosts:function(){$(".scf-js-laterPosts").off("click");
this.switchView(this.filterURLParam.SCHEDULED_LATER_URL_FILTER,".scf-js-laterPosts","#scf-js-laterPosts")},fetchAllPosts:function(){$(".scf-js-allPosts").off("click");this.switchView("",".scf-js-allPosts","#scf-js-allPosts")},switchView:function(c,b,d){this.model.url=this.model.id+a.constants.URL_EXT+c;var e=this;a.log.debug("switchView:"+this.model.url);var f=this.model.get("pageInfo").basePageURL+".html"+c;this.model.reload({success:function(){e.activateTabs(b,d);a.Router.navigate(f,{trigger:!0,
replace:!0})},error:function(){a.log.error("Error reloading model")}})}}),n=function(a,b,c,d){if(a&&b&&c)try{"PM"===d&&"12"!==b?(b=parseInt(b),b+=12):"AM"===d&&"12"===b&&(b=0);var e=6E4*(60*parseInt(b)+parseInt(c)),f=Date.parse(a)+e;return(new Date(f)).toISOString()}catch(m){return NaN}},p=function(a,b){var c=a.getHours(),d=a.getMinutes();b.$el.find(".scf-js-event-basics-start-input").datepicker("setDate",a);a=12<=c?"PM":"AM";c=12<c?c-12:c;c=(10>c?"0"+c:c).toString();"00"===c&&(c="12");d=(10>d?"0"+
d:d).toString();b.$el.find(".scf-js-event-basics-start-hour").val(c);b.$el.find(".scf-js-event-basics-start-min").val(d);b.$el.find(".scf-js-event-basics-start-time-ampm").val(a)},q=a.Post.extend({modelName:"BlogPostModel",DELETE_OPERATION:"social:deleteJournalComment",UPDATE_OPERATION:"social:updateJournalComment",CREATE_OPERATION:"social:createJournalComment",relationships:{items:{collection:"BlogPostList",model:"BlogPostModel"},votes:{model:"VotingModel"}}}),t=a.PostView.extend({viewName:"BlogPost"}),
v=a.Topic.extend({modelName:"BlogTopicModel",DELETE_OPERATION:"social:deleteJournalComment",UPDATE_OPERATION:"social:updateJournalComment",CREATE_OPERATION:"social:createJournalComment",relationships:{items:{collection:"BlogTopicList",model:"BlogTopicModel"},votes:{model:"VotingModel"}},getCustomProperties:function(){var a={subject:this.get("subject")};if(this.has("isDraft")){a.isDraft=this.get("isDraft");var b=this.get("publishDate");d.isEmpty(b)||(a.publishDate=b,a.isScheduled=!0)}this.getConfigValue("usingPrivilegedUsers")&&
(b=this.get("composedFor"),d.isEmpty(b)||(a.composedFor=b));return a}}),u=a.TopicView.extend({viewName:"BlogTopic",COMMUNITY_FUNCTION:"Blog",eventBinded:!1,bindDatePicker:k.prototype.bindDatePicker,showImmediatelyOption:k.prototype.showImmediatelyOption,showPublishOption:k.prototype.showPublishOption,showDraftOption:k.prototype.showDraftOption,draftUrl:k.prototype.filterURLParam.DRAFT_URL_FILTER,init:function(){a.TopicView.prototype.init.call(this);this.listenTo(this.model,this.model.events.DELETED,
this.navigateCancel);this.listenTo(this.model,this.model.events.UPDATED,this.saveDraftHandler)},edit:function(c){this.$el.find(".scf-js-journal-comment-section").toggleClass("scf-is-hidden");a.TopicView.prototype.edit.call(this,c);this.$el.find(".scf-js-topic-details").hide();this.$el.find(".scf-js-topic-details-tags-editable").show();this.$el.find(".scf-comment-toolbar .scf-comment-edit").hide();var b=this.model.get("subject");this.setField("editSubject",b);this.focus("editSubject");this.eventBinded||
(this.bindDatePicker(c),this.eventBinded=!0)},afterRender:function(){a.TopicView.prototype.afterRender.call(this);this.eventBinded||(this.bindDatePicker(),this.eventBinded=!0);var d=this.$el.find(".scf-js-pubish-type \x3e button \x3e span")[0];if(void 0!==d){var b=!1;this.model.get("properties")&&this.model.get("properties").isDraft&&(b=this.model.get("properties").isDraft);var f;this.model.get("publishDate")&&(f=this.model.get("publishDate"));b&&null!=f?(b=this.model.get("message"),this.model.getConfigValue("isRTEEnabled")||
(b=c("\x3cdiv/\x3e").html(b).text()),this.setField("editMessage",b),this.focus("editMessage"),$(d).text(CQ.I18n.getMessage("At scheduled date and time")),p(new Date(f),this),this.showPublishOption()):b&&(b=this.model.get("message"),this.model.getConfigValue("isRTEEnabled")||(b=c("\x3cdiv/\x3e").html(b).text()),this.setField("editMessage",b),this.focus("editMessage"),$(d).text(CQ.I18n.getMessage("Draft")),this.showDraftOption())}},saveDraftHandler:function(a){a.model.get("draft")&&(window.location.href=
this.model.get("pageInfo").basePageURL+".html"+this.draftUrl)},navigateCancel:function(a){window.location.href=this.model.get("pageInfo").basePageURL+".html"},cancel:function(c){this.$el.find(".scf-js-journal-comment-section").toggleClass("scf-is-hidden");a.TopicView.prototype.cancel.call(this,c);this.$el.find(".scf-js-topic-details").show();this.$el.find(".scf-js-topic-details-tags-editable").hide();this.$el.find(".scf-comment-toolbar .scf-comment-edit").show()},getOtherProperties:function(a){var b=
this.getField("editSubject").trim(),c={tags:this.getField("editTags")};a||(c.subject=b);a=$(this.$el.find(".scf-js-pubish-type \x3e button \x3e span")).text();d.isEmpty(a)||a!=$(this.$el.find(".scf-js-pubish-type \x3e ul \x3e li \x3e a")[1]).text()?d.isEmpty(a)||a!=$(this.$el.find(".scf-js-pubish-type \x3e ul \x3e li \x3e a")[2]).text()?c.isDraft=!1:(c.isDraft=!0,c.isScheduled=!0,c.publishDate=n(this.$el.find(".scf-js-event-basics-start-input").val(),this.$el.find(".scf-js-event-basics-start-hour").val(),
this.$el.find(".scf-js-event-basics-start-min").val(),this.$el.find(".scf-js-event-basics-start-time-ampm").val())):c.isDraft=!0;this.model.getConfigValue("usingPrivilegedUsers")&&(a=this.getField("composedFor"),d.isEmpty(a)||(c.composedFor=a));this.eventBinded=!1;return c},deleteArticle:function(a){a.stopPropagation();this.unbindDataFields();this.model.remove()},toggleComposerCollapse:function(a){$(a.target.closest(".scf-js-composer-block")).toggleClass("scf-is-collapsed");this.focus("replyMessage")}}),
g=f.Collection.extend({collectionName:"BlogTopicList"});f=f.Collection.extend({collectionName:"BlogPostList"});a.BlogPost=q;a.BlogTopic=v;a.Journal=l;a.BlogTopicView=u;a.BlogPostView=t;a.JournalView=k;a.BlogTopicList=g;a.BlogPostList=f;a.registerComponent("social/journal/components/hbs/comment",a.BlogPost,a.BlogPostView);a.registerComponent("social/journal/components/hbs/entry_topic",a.BlogTopic,a.BlogTopicView);a.registerComponent("social/journal/components/hbs/journal",a.Journal,a.JournalView)})($CQ,
_,Backbone,SCF);